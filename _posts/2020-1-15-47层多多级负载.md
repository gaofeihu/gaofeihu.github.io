---
layout:     post
title:  4、7层多级别负载
subtitle: 
date:       2020-1-8
author:     silence
header-img: img/post-linux.png
catalog: true
tags:
    - linux
    - 4、7层多级别负载
---

### 1.需求

- 公司有两个不同域名的门户网站 

- 业务高峰期访问量较大，经测试 Nginx 未能满足并发压力 

- 两个门户网站公网地址一致 

### 2.环境准备

Lvs *1	服务器为10.10.10.11

Nginx * 2	服务器为10.10.10.12、13

Apache * 3  服务器为10.10.10.14、15（www.fehu.com）16(www.fehu.cn)

### 3. 说明

nginx 7工作在层代理，可以识别域名，是利用反向代理实现的负载均衡，对于一次请求其实是两次，压力比较大，出入站都需要经过Nginx。

lvs工作在4层，lvs  DR模式是利用数据包修改+请求转发，它只处理入站请求，压力比较小，并发量大，只能识别IP+端口的负载均衡。

### 4.  apache安装(14、15、16)

```bash
yum -y install httpd
service httpd start && echo "www.fehu.com" > /var/www/html/index.html
```

### 5.nginx安装

##### 安装依赖

```bash
yum install -y pcre pcre-devel zlib zlib-devel openssl-devel gcc gcc-c++
```

##### 添加nginx用户

```bash
useradd -r -s /sbin/nologin -M nginx
```

##### 编译安装

```bash
tar -zxvf nginx-1.2.6.tar.gz
./configure --prefix=/usr/local/nginx --user=nginx --group=nginx --with-http_stub_status_module --with-http_ssl_module --with-http_realip_module
make && make install

#启用 realip 模块（将用户 IP 转发给后端服务器）

# 添加缓存清除扩展模块
--add-module=../ngx_cache_purge-1.3
# 查看安装了哪些模块
/usr/local/nginx/sbin/nginx -V
```

##### 配置反向代理

```

```



##### 启动nginx

```bash

/usr/local/nginx/sbin/nginx
```

